<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Livres - LMS</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
</head>
<body>
{% include 'includes/navbar.html' %}
<div class="container">
    <h3 class="mb-4"><i class="bi bi-book me-2"></i>Livres</h3>
    <!-- Nouveau: filtre catégories -->
    {% set categories_list = categories if categories is defined else (books | map(attribute='category') | unique) %}
    <div class="row g-3 align-items-end mb-3">
        <div class="col-md-4">
            <label for="filterCategory" class="form-label mb-1"><i class="bi bi-filter me-1"></i>Filtrer par catégorie</label>
            <select id="filterCategory" class="form-select">
                <option value="">Toutes les catégories</option>
                {% for c in categories_list %}
                    <option value="{{ c.name if c is not string else c }}">{{ c.name if c is not string else c }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-8 d-flex justify-content-end">
            <button class="btn btn-primary" id="addBookButton" title="Ajouter un nouveau livre">
                <i class="bi bi-plus-circle me-2"></i>Ajouter un livre
            </button>
        </div>
    </div>
    <!-- Statistiques Clés -->
    <div class="row text-center mb-4">
        <div class="col-md-6">
            <div class="card bg-light">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-book me-2"></i>Total Livres</h5>
                    <p class="card-text display-4">{{ total_books }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-light">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-bar-chart me-2"></i>Livres Populaires</h5>
                    <p class="card-text display-4">{{total_popular_books}}</p>
                </div>
            </div>
        </div>
    </div>



    <div class="table-responsive">
        <table id="booksTable" class="table table-striped table-hover align-middle">
            <thead class="table-primary">
                <tr>
                    <th><i class="bi bi-book"></i> Titre</th>
                    <th><i class="bi bi-person"></i> Auteur</th>
                    <th><i class="bi bi-tags"></i> Catégorie</th>
                    <th><i class="bi bi-check-circle"></i> Disponibilité</th>
                    <th><i class="bi bi-eye"></i> Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for book in books %}
                    <tr data-book-id="{{ book.id }}" data-isbn="{{ book.isbn }}" data-publication-year="{{ book.publication_year }}" data-publisher="{{ book.publisher }}" data-quantity="{{ book.quantity }}" data-available-quantity="{{ book.available_quantity }}">
                        <td>{{ book.title }}</td>
                        <td>{{ book.author }}</td>
                        <td>{{ book.category }}</td>
                        <td>
                            {% if book.available_quantity > 0 %}
                            <span class="badge bg-success">Disponible</span>
                            {% else %}
                            <span class="badge bg-danger">Emprunté</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-info btn-sm see-detail-book" title="Voir détails"><i class="bi bi-eye"></i></button>
                            <button class="btn btn-warning btn-sm edit-book" title="Modifier"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-danger btn-sm delete-book" title="Supprimer"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Modal pour afficher les détails d'un livre -->
    <div class="modal fade" id="bookDetailsModal" tabindex="-1" aria-labelledby="bookDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="bookDetailsModalLabel">
                        <i class="bi bi-book me-2"></i>Détails du Livre
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3"><i class="bi bi-info-circle me-2"></i>Informations Générales</h6>
                            <table class="table table-borderless">
                                <tr>
                                    <th>Titre :</th>
                                    <td><span id="bookTitle"></span></td>
                                </tr>
                                <tr>
                                    <th>Auteur :</th>
                                    <td><span id="bookAuthor"></span></td>
                                </tr>
                                <tr>
                                    <th>Catégorie :</th>
                                    <td><span id="bookCategory"></span></td>
                                </tr>
                                <tr>
                                    <th>ISBN :</th>
                                    <td><span id="bookISBN"></span></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3"><i class="bi bi-geo-alt me-2"></i>Détails Supplémentaires</h6>
                            <table class="table table-borderless">
                                <tr>
                                    <th>Année :</th>
                                    <td><span id="bookPublicationYear"></span></td>
                                </tr>
                                <tr>
                                    <th>Éditeur :</th>
                                    <td><span id="bookPublisher"></span></td>
                                </tr>
                                <tr>
                                    <th>Quantité :</th>
                                    <td><span id="bookQuantity"></span></td>
                                </tr>
                                <tr>
                                    <th>Disponible :</th>
                                    <td><span id="bookAvailableQuantity"></span></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour modifier un livre -->
    <div class="modal fade" id="editBookModal" tabindex="-1" aria-labelledby="editBookModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editBookModalLabel">
                        <i class="bi bi-pencil-square me-2"></i>Modifier le Livre
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editBookForm">
                        <div class="mb-3">
                            <label for="editBookTitle" class="form-label">Titre <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editBookTitle" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="editBookAuthor" class="form-label">Auteur <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editBookAuthor" name="author" required>
                        </div>
                        <div class="mb-3">
                            <label for="editBookCategory" class="form-label">Catégorie <span class="text-danger">*</span></label>
                            <select class="form-control" id="editBookCategory" name="category" required>
                                <option value="">Sélectionnez une catégorie</option>
                                {% for c in categories_list %}
                                    <option value="{{ c.name if c is not string else c }}">{{ c.name if c is not string else c }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editBookISBN" class="form-label">ISBN <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editBookISBN" name="isbn" required>
                        </div>
                        <div class="mb-3">
                            <label for="editBookPublicationYear" class="form-label">Année de publication <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="editBookPublicationYear" name="publication_year" required>
                        </div>
                        <div class="mb-3">
                            <label for="editBookPublisher" class="form-label">Éditeur <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editBookPublisher" name="publisher" required>
                        </div>
                        <div class="mb-3">
                            <label for="editBookQuantity" class="form-label">Quantité <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="editBookQuantity" name="quantity" required>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-2"></i>Enregistrer
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour supprimer un livre -->
    <div class="modal fade" id="deleteBookModal" tabindex="-1" aria-labelledby="deleteBookModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteBookModalLabel">
                        <i class="bi bi-exclamation-triangle me-2"></i>Confirmer la suppression
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Êtes-vous sûr de vouloir supprimer ce livre ?</p>
                    <p class="text-danger">Cette action est irréversible.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBook">
                        <i class="bi bi-trash me-2"></i>Supprimer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour ajouter un nouveau livre -->
    <div class="modal fade" id="addBookModal" tabindex="-1" aria-labelledby="addBookModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="addBookModalLabel">
                        <i class="bi bi-plus-circle me-2"></i>Ajouter un Nouveau Livre
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addBookForm">
                        <div class="mb-3">
                            <label for="addBookTitle" class="form-label">Titre <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="addBookTitle" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="addBookAuthor" class="form-label">Auteur <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="addBookAuthor" name="author" required>
                        </div>
                        <div class="mb-3">
                            <label for="addBookCategory" class="form-label">Catégorie <span class="text-danger">*</span></label>
                            <select class="form-control" id="addBookCategory" name="category" required>
                                <option value="">Sélectionnez une catégorie</option>
                                {% for c in categories_list %}
                                    <option value="{{ c.name if c is not string else c }}">{{ c.name if c is not string else c }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="addBookISBN" class="form-label">ISBN <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="addBookISBN" name="isbn" required>
                        </div>
                        <div class="mb-3">
                            <label for="addBookPublicationYear" class="form-label">Année de publication <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="addBookPublicationYear" name="publication_year" required>
                        </div>
                        <div class="mb-3">
                            <label for="addBookPublisher" class="form-label">Éditeur <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="addBookPublisher" name="publisher" required>
                        </div>
                        <div class="mb-3">
                            <label for="addBookQuantity" class="form-label">Quantité <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="addBookQuantity" name="quantity" required>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-2"></i>Ajouter
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3">
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script>
(function(){
    function esc(str){
        return String(str===undefined||str===null?'':str).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }
    let dt = null;
    const table = document.getElementById('booksTable');
    const tbody = table.querySelector('tbody');
    let currentCategory = '';

    function initDataTable(){
        if ($.fn.DataTable.isDataTable('#booksTable')) {
            $('#booksTable').DataTable().destroy();
        }
        dt = $('#booksTable').DataTable({
            language:{ url:'https://cdn.datatables.net/plug-ins/1.13.4/i18n/fr-FR.json' },
            pageLength:25
        });
    }

    function showLoading(state){
        const sel = document.getElementById('filterCategory');
        if(!sel) return;
        sel.disabled = !!state;
        if(state){ sel.classList.add('opacity-50'); }
        else { sel.classList.remove('opacity-50'); }
    }

    function buildRowsHTML(books){
        if(!books.length){
            return '<tr><td colspan="5" class="text-center text-muted">Aucun livre pour cette catégorie.</td></tr>';
        }
        return books.map(b=>`<tr data-book-id="${esc(b.id)}" data-isbn="${esc(b.isbn)}" data-publication-year="${esc(b.publication_year)}" data-publisher="${esc(b.publisher)}" data-quantity="${esc(b.quantity)}" data-available-quantity="${esc(b.available_quantity)}">`
            +`<td>${esc(b.title)}</td>`
            +`<td>${esc(b.author)}</td>`
            +`<td>${esc(b.category)}</td>`
            +`<td>${b.available_quantity>0?'<span class="badge bg-success">Disponible</span>':'<span class="badge bg-danger">Emprunté</span>'}</td>`
            +`<td>`
                +`<button class="btn btn-info btn-sm see-detail-book" title="Voir détails"><i class="bi bi-eye"></i></button> `
                +`<button class="btn btn-warning btn-sm edit-book" title="Modifier"><i class="bi bi-pencil"></i></button> `
                +`<button class="btn btn-danger btn-sm delete-book" title="Supprimer"><i class="bi bi-trash"></i></button>`
            +`</td>`
        +`</tr>`).join('');
    }

    function renderBooks(books){
        // Remplacer le corps du tableau
        tbody.innerHTML = buildRowsHTML(books);
        // Réinitialiser DataTables
        initDataTable();
    }

    function fetchBooks(category){
        showLoading(true);
        const url = '/books/api' + (category? ('?category='+encodeURIComponent(category)) : '');
        console.debug('[Filtre catégories] Chargement:', url);
        fetch(url)
            .then(r=>r.json())
            .then(data=>{
                if(data.error){ console.error('Erreur API', data.error); return; }
                renderBooks(data.books||[]);
            })
            .catch(err=> console.error('Erreur chargement livres filtrés:', err))
            .finally(()=> showLoading(false));
    }

    function openDetails(tr){
        const d = {
            title: tr.querySelector('td:nth-child(1)').textContent,
            author: tr.querySelector('td:nth-child(2)').textContent,
            category: tr.querySelector('td:nth-child(3)').textContent,
            isbn: tr.dataset.isbn,
            publicationYear: tr.dataset.publicationYear,
            publisher: tr.dataset.publisher,
            quantity: tr.dataset.quantity,
            availableQuantity: tr.dataset.availableQuantity
        };
        document.getElementById('bookTitle').textContent = d.title;
        document.getElementById('bookAuthor').textContent = d.author;
        document.getElementById('bookCategory').textContent = d.category;
        document.getElementById('bookISBN').textContent = d.isbn;
        document.getElementById('bookPublicationYear').textContent = d.publicationYear;
        document.getElementById('bookPublisher').textContent = d.publisher;
        document.getElementById('bookQuantity').textContent = d.quantity;
        document.getElementById('bookAvailableQuantity').textContent = d.availableQuantity;
        new bootstrap.Modal(document.getElementById('bookDetailsModal')).show();
    }

    // Délégation des événements (un seul binding permanent)
    tbody.addEventListener('click', function(e){
        const btn = e.target.closest('button');
        if(!btn) return;
        const tr = btn.closest('tr');
        if(btn.classList.contains('see-detail-book')){
            openDetails(tr);
        } else if(btn.classList.contains('edit-book')){
            const modal = document.getElementById('editBookModal');
            modal.dataset.currentBookId = tr.dataset.bookId;
            document.getElementById('editBookTitle').value = tr.querySelector('td:nth-child(1)').textContent;
            document.getElementById('editBookAuthor').value = tr.querySelector('td:nth-child(2)').textContent;
            document.getElementById('editBookCategory').value = tr.querySelector('td:nth-child(3)').textContent;
            document.getElementById('editBookISBN').value = tr.dataset.isbn;
            document.getElementById('editBookPublicationYear').value = tr.dataset.publicationYear;
            document.getElementById('editBookPublisher').value = tr.dataset.publisher;
            document.getElementById('editBookQuantity').value = tr.dataset.quantity;
            new bootstrap.Modal(modal).show();
        } else if(btn.classList.contains('delete-book')){
            const modal = document.getElementById('deleteBookModal');
            modal.dataset.bookIdToDelete = tr.dataset.bookId;
            document.getElementById('deleteBookModalLabel').textContent = 'Supprimer le Livre: ' + tr.querySelector('td:first-child').textContent;
            new bootstrap.Modal(modal).show();
        }
    });

    document.getElementById('filterCategory')?.addEventListener('change', function(){
        currentCategory = this.value || '';
        fetchBooks(currentCategory);
    });

    // Initialisation
    document.addEventListener('DOMContentLoaded', function(){
        initDataTable();
    });
})();
</script>
</body>
</html>
